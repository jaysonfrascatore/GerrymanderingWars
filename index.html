<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive US Map with Gerrymandering Advantage Sidebar</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<style>
  :root {
    --card-bg: #ffffff;
    --muted: #666;
    --accent-red: #d33;
    --accent-blue: #357edd;
    --accent-yellow: #df9a57;
    --gray-ccc: #eee;
    --panel-radius: 12px;
    --max-width: 1200px;
  }

  body {
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin: 20px;
    display: flex;
    gap: 20px;
    flex-direction: column;
    align-items: center;
    background: #f6f8fa;
    color: #111;
  }

  .container {
    width: 100%;
    max-width: var(--max-width);
    box-sizing: border-box;
    padding: 0 16px;
  }

  /* Title styling */
  .page-head h1 {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 0.5em;
    text-align: center;
  }

  /* Center banner text + make it boldish */
  #bannerText {
    text-align: center;
    font-size: 1.25rem;
    font-weight: 600;
  }

  /* Make the banner container center its content vertically & horizontally */
  .top-banner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  /* Evaluation bar styles */
  #evalBar {
    display: flex;
    width: 100%;
    max-width: var(--max-width);
    height: 40px;
    border-radius: 12px;
    overflow: hidden;
    font-weight: 700;
    color: white;
    user-select: none;
    box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
  }
  #evalBar .segment.red {
    background-color: var(--accent-red);
    display: flex;
    justify-content: center;
    align-items: center;
    transition: width 0.5s ease;
    min-width: 40px;
  }
  #evalBar .segment.blue {
    background-color: var(--accent-blue);
    display: flex;
    justify-content: center;
    align-items: center;
    transition: width 0.5s ease;
    min-width: 40px;
  }

  /* Seat lead pill with white text and background color */
  .Seat-Lead.r {
    background-color: var(--accent-red);
    color: white;
    font-weight: 800;
    padding: 4px 10px;
    border-radius: 20px;
    margin-left: 6px;
    display: inline-block;
  }
  .Seat-Lead.d {
    background-color: var(--accent-blue);
    color: white;
    font-weight: 800;
    padding: 4px 10px;
    border-radius: 20px;
    margin-left: 6px;
    display: inline-block;
  }

  /* Map + tooltip container */
  #map-container {
    position: relative;
    width: 100%;
    max-width: var(--max-width);
  }

  #map {
    border: 0;
    width: 100%;
    height: auto;
    aspect-ratio: 16 / 9;
    display: block;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(12,18,26,0.06);
    background: linear-gradient(180deg,#ffffff,#fbfdff);
    margin: 0 auto;
  }

  /* Tooltip */
  #tooltip {
    position: absolute;
    pointer-events: none;
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    max-width: 240px;
    opacity: 0;
    transition: opacity 0.15s ease;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    z-index: 1000;
  }

  #legend {
    margin-top: 4px;
    font-family: Inter, Arial, sans-serif;
    display: flex;
    gap: 18px;
    align-items: center;
    user-select: none;
    flex-wrap: wrap;
    justify-content: flex-start;
    font-size: 13px;
    padding-bottom: 6px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: default;
    transition: transform 0.12s ease;
  }

  .color-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  }

  .pickup-label {
    font-weight: 800;
    font-size: 13px;
    fill: white;
    pointer-events: none;
    text-shadow: 0 0 5px rgba(0,0,0,0.65);
  }

  svg .state {
    cursor: pointer;
    stroke: #fff;
    stroke-width: 1;
    transition: fill 0.25s;
  }

  .red-highlight {
    background-color: var(--accent-red);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 800;
    margin-left: 6px;
  }

  .blue-highlight {
    background-color: var(--accent-blue);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 800;
    margin-left: 6px;
  }

  /* Mobile tweaks */
  @media (max-width: 600px) {
    #evalBar { height: 44px; }
    .segment { font-size: 15px; }
    #bannerSummary { font-size: 16px; }
    .seat-lead { font-size: 14px; padding: 5px 8px; }
  }

  @media (max-width: 600px) {
    body { margin: 10px; }
    h1 { font-size: 2.5rem; }
    .top-banner { padding: 12px; }
  }
</style>
</head>
<body>

<div class="container">
  <header class="page-head">
    <div class="title-row">
      <h1>2026 Gerrymandering Wars</h1>
      <div style="color:var(--muted); font-weight:600; align-self:center;">Last Updated: 8/15/2025, 11:24 AM</div>
    </div>

    <div class="top-banner" role="region" aria-label="Gerrymandering summary banner">
      <div id="evalBar" aria-hidden="true">
        <div class="segment red" style="width: 50%;">R+0</div>
        <div class="segment blue" style="width: 50%;">D+0</div>
      </div>

      <div id="bannerSummary" aria-live="polite">
        <div id="bannerText">No Gerrymandered Seat Lead detected for 2026.</div>
        <div id="bannerLead" style="margin-left:auto;"></div>
      </div>
    </div>
  </header>

  <!-- Map + tooltip container -->
  <div id="map-container">
    <svg id="map" width="960" height="600" aria-label="Map of United States"></svg>
    <div id="tooltip" role="status" aria-hidden="true"></div>
  </div>

  <!-- Sidebar -->
  <div id="sidebar" class="container">
    <div id="summary">See the current gerrymandering advantage.</div>

    <div id="legend" aria-hidden="false">
      <div class="legend-item" data-color="gray">
        <div class="color-box" style="background: gray;"></div>
        <span style="font-weight:700; color:var(--muted)">No Current Plans</span>
      </div>
      <div class="legend-item" data-color="#df9a57">
        <div class="color-box" style="background: var(--accent-yellow);"></div>
        <span style="font-weight:700; color:var(--muted)">Unclear</span>
      </div>
      <div class="legend-item" data-color="blue">
        <div class="color-box" style="background: var(--accent-blue);"></div>
        <span style="font-weight:700; color:var(--muted)">Democratic Gerrymandering</span>
      </div>
      <div class="legend-item" data-color="red">
        <div class="color-box" style="background: var(--accent-red);"></div>
        <span style="font-weight:700; color:var(--muted)">Republican Gerrymandering</span>
      </div>
    </div>
  </div>
</div>

<script>
// Map setup
const width = 960;
const height = 600;
const svg = d3.select("#map");
const tooltip = d3.select("#tooltip");
const projection = d3.geoAlbersUsa().translate([width / 2, height / 2]).scale(1300);
const path = d3.geoPath().projection(projection);

const nameToAbbr = {
  "Alabama": "AL", "Alaska": "AK", "Arizona": "AZ", "Arkansas": "AR", "California": "CA", "Colorado": "CO",
  "Connecticut": "CT", "Delaware": "DE", "Florida": "FL", "Georgia": "GA", "Hawaii": "HI", "Idaho": "ID",
  "Illinois": "IL", "Indiana": "IN", "Iowa": "IA", "Kansas": "KS", "Kentucky": "KY", "Louisiana": "LA",
  "Maine": "ME", "Maryland": "MD", "Massachusetts": "MA", "Michigan": "MI", "Minnesota": "MN",
  "Mississippi": "MS", "Missouri": "MO", "Montana": "MT", "Nebraska": "NE", "Nevada": "NV",
  "New Hampshire": "NH", "New Jersey": "NJ", "New Mexico": "NM", "New York": "NY", "North Carolina": "NC",
  "North Dakota": "ND", "Ohio": "OH", "Oklahoma": "OK", "Oregon": "OR", "Pennsylvania": "PA",
  "Rhode Island": "RI", "South Carolina": "SC", "South Dakota": "SD", "Tennessee": "TN", "Texas": "TX",
  "Utah": "UT", "Vermont": "VT", "Virginia": "VA", "Washington": "WA", "West Virginia": "WV",
  "Wisconsin": "WI", "Wyoming": "WY", "District of Columbia": "DC"
};

function getColorByPickup(pickup, plan) {
  if (pickup) {
    const p = pickup.trim();
    if (p.startsWith("R+")) return "red";
    if (p.startsWith("D+")) return "blue";
  }
  if (!plan) return "#ccc";
  const lowerPlan = plan.trim().toLowerCase();
  if (lowerPlan === "yes") return "red";
  if (lowerPlan === "no") return "gray";
  if (lowerPlan === "unclear") return "#df9a57";  // yellow
  return "#ccc";
}

let dataMap = {};

d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(us => {
  const states = topojson.feature(us, us.objects.states).features;

  svg.selectAll("path")
    .data(states)
    .join("path")
    .attr("class", "state")
    .attr("d", path)
    .attr("id", d => fipsToStateAbbr(d.id))
    .attr("fill", "#eee")
    .on("mousemove", (event, d) => {
      const abbr = fipsToStateAbbr(d.id);
      const info = dataMap[abbr];
      if (!info) {
        tooltip.style("opacity", 0).attr("aria-hidden", "true");
        return;
      }
      const [x, y] = d3.pointer(event, d3.select("#map-container").node());
      tooltip.style("opacity", 1)
        .attr("aria-hidden", "false")
        .style("left", (x + 10) + "px")
        .style("top", (y + 10) + "px")
        .html(`
          <strong style="font-size:14px;">${abbr}</strong><br/>
          <small style="color:#ddd">Governor Party:</small> ${info.governorParty || 'N/A'}<br/>
          <small style="color:#ddd">Republican Seats:</small> ${info.republicanSeats || 'N/A'}<br/>
          <small style="color:#ddd">Democratic Seats:</small> ${info.democraticSeats || 'N/A'}<br/>
          <small style="color:#ddd">Plan to Redraw:</small> ${info.planToRedraw || 'N/A'}<br/>
          <small style="color:#ddd">Retaliate To State:</small> ${info.retaliateToState || 'N/A'}<br/>
          <small style="color:#ddd">Partisan Redraw 2026 Pickup:</small> ${info.partisanRedrawPickup || 'N/A'}
        `);
    })
    .on("mouseleave", () => tooltip.style("opacity", 0).attr("aria-hidden", "true"));

  loadCsvData(csvUrl);
});

const csvUrl = "https://raw.githubusercontent.com/jaysonfrascatore/GerrymanderingWars/main/data/Gerrymandering_Wars_8-15-2025.csv";

function loadCsvData(url) {
  d3.csv(url).then(rows => {
    dataMap = {};

    rows.forEach(row => {
      const fullName = row["State"]?.trim();
      if (!fullName) return;
      const abbr = nameToAbbr[fullName];
      if (!abbr) return;

      dataMap[abbr] = {
        governorParty: row["Governor Party"],
        republicanSeats: row["Republican Seats"],
        democraticSeats: row["Democratic Seats"],
        planToRedraw: row["Plan to Redraw"],
        retaliateToState: row["Retaliate To State"],
        partisanRedrawPickup: row["Partisan Redraw 2026 Pickup"]
      };
    });

    d3.selectAll("path.state")
      .attr("fill", d => {
        const abbr = fipsToStateAbbr(d.id);
        const info = dataMap[abbr];
        if (!info) return "#eee";
        return getColorByPickup(info.partisanRedrawPickup, info.planToRedraw);
      });

    updatePickupLabels();
    updateGerrymanderSummary();
  }).catch(err => {
    console.error("Failed to load CSV:", err);
  });
}

function fipsToStateAbbr(fips) {
  const fipsMap = {
    "01": "AL", "02": "AK", "04": "AZ", "05": "AR", "06": "CA", "08": "CO", "09": "CT", "10": "DE",
    "11": "DC", "12": "FL", "13": "GA", "15": "HI", "16": "ID", "17": "IL", "18": "IN", "19": "IA",
    "20": "KS", "21": "KY", "22": "LA", "23": "ME", "24": "MD", "25": "MA", "26": "MI", "27": "MN",
    "28": "MS", "29": "MO", "30": "MT", "31": "NE", "32": "NV", "33": "NH", "34": "NJ", "35": "NM",
    "36": "NY", "37": "NC", "38": "ND", "39": "OH", "40": "OK", "41": "OR", "42": "PA", "44": "RI",
    "45": "SC", "46": "SD", "47": "TN", "48": "TX", "49": "UT", "50": "VT", "51": "VA", "53": "WA",
    "54": "WV", "55": "WI", "56": "WY"
  };
  return fipsMap[fips.toString().padStart(2, "0")] || null;
}

function updatePickupLabels() {
  svg.selectAll(".pickup-label").remove();

  svg.selectAll("path.state")
    .each(function(d) {
      const abbr = fipsToStateAbbr(d.id);
      const info = dataMap[abbr];
      if (info && info.planToRedraw?.trim().toLowerCase() === "yes" && info.partisanRedrawPickup) {
        const coords = path.centroid(d);
        svg.append("text")
          .attr("class", "pickup-label")
          .attr("x", coords[0])
          .attr("y", coords[1])
          .attr("text-anchor", "middle")
          .attr("alignment-baseline", "middle")
          .text(info.partisanRedrawPickup);
      }
    });
}

function updateGerrymanderSummary() {
  let rTotal = 0;
  let dTotal = 0;

  Object.values(dataMap).forEach(info => {
    const pickup = info.partisanRedrawPickup?.trim();
    if (pickup) {
      if (pickup.startsWith("R+")) {
        rTotal += Number(pickup.substring(2)) || 0;
      } else if (pickup.startsWith("D+")) {
        dTotal += Number(pickup.substring(2)) || 0;
      }
    }
  });

  const bannerText = d3.select("#bannerText");
  const bannerLead = d3.select("#bannerLead");

  if (rTotal === 0 && dTotal === 0) {
    bannerText.text("No Gerrymandered Seat Lead detected in 2026.");
    bannerLead.html("");  // Clear it just in case
  } else {
    const netLead = rTotal - dTotal;

    if (netLead > 0) {
      bannerText.html(`  
        <span class="Seat-Lead r">Republicans</span> Currently Plan to Gerrymander a <span class="Seat-Lead r">${netLead} Seat Lead</span> Over <span class="Seat-Lead d">Democrats</span> in 2026.
      `);
    } else if (netLead < 0) {
      bannerText.html(`
        <span class="Seat-Lead d">Democrats</span> Currently Plan to Gerrymander a <span class="Seat-Lead d">${Math.abs(netLead)} Seat Lead</span> Over <span class="Seat-Lead r">Republicans</span> in 2026.
      `);
    } else {
      bannerText.html("No Gerrymandered Seat Lead detected in 2026.");
    }

    // REMOVE the bannerLead update so no redundant lead pill:
    bannerLead.html("");  // Just clear it so nothing shows up
  }

  // Update evaluation bar dynamically (unchanged)
  const evalBar = d3.select("#evalBar");
  const totalPickups = rTotal + dTotal;
  const rPercent = totalPickups ? (rTotal / totalPickups) * 100 : 50;
  const dPercent = totalPickups ? (dTotal / totalPickups) * 100 : 50;

  evalBar.html(`
    <div class="segment red" style="width: ${rPercent}%; min-width: 40px;">R+${rTotal}</div>
    <div class="segment blue" style="width: ${dPercent}%; min-width: 40px;">D+${dTotal}</div>
  `);
}
</script>
</body>
</html>
